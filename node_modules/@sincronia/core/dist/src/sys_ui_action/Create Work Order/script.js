"use strict";

var woTypeMap = {
  x_nuvo_eam_clinical_work_order_types: 'x_nuvo_eam_clinical_work_orders',
  x_nuvo_eam_facilities_work_order_types: 'x_nuvo_eam_facilities_work_orders',
  x_nuvo_eam_lab_work_order_types: 'x_nuvo_eam_lab_work_orders'
};

if (current.getValue('work_order_type') === '' || current.getValue('work_order_type') == null) {
  var e = gs.getMessage('CSD_CALL_NO_WORK_ORDER_TYPE');
  gs.addErrorMessage(e);
} else {
  var woTypeGr = current.work_order_type.getRefRecord();
  var woType = woTypeGr.getValue('sys_class_name');
  var woTable = 'x_nuvo_eam_facilities_work_orders';

  if (woType && woTypeMap[woType]) {
    woTable = woTypeMap[woType];
  }

  var newWo = '';
  var woGr = new GlideRecord(woTable);
  woGr.newRecord();

  if (current.getValue('call_type') === 'asset') {
    woGr.setValue('asset', current.getValue('asset'));
  }

  if (current.getValue('call_type') === 'space') {
    woGr.setValue('space', current.getValue('space'));
  }

  woGr.setValue('asset_location', current.getValue('call_type'));
  woGr.setValue('work_order_type', current.getValue('work_order_type'));
  var contactGR = current.contact.getRefRecord();
  woGr.setValue('service_provider', contactGR.getValue('company'));
  woGr.setValue('x_nuvo_csd_call', current.getValue('sys_id'));
  woGr.setValue('short_description', current.getValue('short_description'));
  woGr.setValue('description', current.getValue('description'));
  woGr.setValue('state', 1);
  woGr.setValue('priority', current.getValue('priority'));
  newWo = woGr.insert();

  if (newWo !== '') {
    current.setValue('state', '5');
    current.setValue('escalated', true);
    current.setValue('work_order', newWo);
    current.update();
    var currentURL = gs.getUrlOnStack();
    action.setRedirectURL(currentURL);
  } else {
    gs.addErrorMessage(gs.getMessage('CSD_CALL_CREATE_WORK_ORDER_ERROR'));
  }
}